<div class="modal fade" id="tags_selection_modal" role="dialog" style="overflow:hidden;">
    <div class="modal-dialog modal-xl modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add tags to the selected case.</h5>
                <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="case_id" name="case_id">
                Select from available tags or type in a new one:
                <select class="form-control myselect2" multiple="multiple" id="select_tags" style="color: black">
                </select>                               
            </div>
            <div class="modal-footer">
                <button type="button" id="btn_ok" onclick="updateTags()" class="btn btn-primary">OK</button>
                <button type="button" class="btn btn-primary" data-mdb-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>


<script>

$(document).ready(function() {
    $('.modal .myselect2').select2({
        tags: true,
        width: '100%',
        dropdownParent: $('.modal')
    });
});

// Retrieves that information for the given case from the server and shows a modal popup window with
// the information
function showTagsDialog(case_id) {
    var ajax1 = $.ajax({ 
        type: 'GET',
        dataType: "json",
        url: '/browser/get_case/'+case_id,
        async: true,
        error: function () {
            // Show error if the data cannot be read from server
            Swal.fire(
                'Error',
                'Unable to find case information.',
                'error'
            )
        },
        success: function(result) {},
        timeout: 3000                    
    });
    var ajax2 = $.ajax({ 
        type: 'GET',
        dataType: "json",
        url: '/browser/get_tags_all',
        async: true,
        error: function () {
            // Show error if the data cannot be read from server
            Swal.fire(
                'Error',
                'Unable to find tags information.',
                'error'
            )
        },
        success: function(result) {},
        timeout: 3000 
    });
    $.when( ajax1 , ajax2  ).done(function( case_data, tags_data ) {
        displayTagsInformation(case_data[0].case_id, case_data[0].tags, tags_data[0].tags);
    });
}

// Renders the retrieved JSON information in modal window and displays it 
function displayTagsInformation(case_id, case_tags, all_tags) {
    const case_id_el = document.getElementById("case_id");
    case_id_el.innerText = case_id;
    let tag_select = $('.myselect2');  

    $('.myselect2').val(null).trigger('change');

    for (const tag of case_tags) {
        // create the option and append to Select2
        let option = new Option(tag, tag, true, true);
        tag_select.append(option).trigger('change');

        // manually trigger the `select2:select` event
        // tag_select.trigger({
        // type: 'select2:select',
        // params: {
        //     data: case_tags
        // }
        // });
    }

    // tags that do not currently belong to the case, but need to be made available to select
    let other_tags = all_tags.filter(x => !case_tags.includes(x));
    for (const tag of other_tags) {
        // create the option and append to Select2
        let option = new Option(tag, tag, false, false);
        tag_select.append(option);
    }    

    // Display the modal window
    const myModalElement = document.getElementById('tags_selection_modal');
    const modal = new mdb.Modal(myModalElement);
    modal.show();
}

function updateTags() {
    const selected = $('.myselect2').find(':selected');
    const case_id = document.getElementById("case_id").innerText;
    const tags = [];
    for (let i = 0; i < selected.length; i++) {
        tags.push(selected[i].text);
    }    
    sendData({tags: tags, case_id: case_id}).then(result => {
        if(result.status == "OK") {
            window.location.reload();
            $('#tags_selection_modal').modal('hide');
        }
        else {
            Swal.fire(
                'Error',
                'Unable to update tags information.',
                'error'
            )
        }
    });

   
    
}

// after tags are updated in the dialog, need to update the database
async function sendData(data){
  let response = await fetch('/tags/', {
    method: 'POST',
    headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}',
    },
    body: JSON.stringify(data)
  });
  const result = await response.json();
  return result;
//   if(response != "OK") {
//       let error=await response.text();
//       console.log(`failed updating tags: ${error}`);
//   }          
}

</script>
