{% extends 'portal.html' %}

{% block header %}
<script src="/static/js/dygraph.min.js"></script>
<link rel="stylesheet" href="/static/css/dygraph.min.css" />
{% endblock %}

{% block addedscripts %}
<script defer src="/static/js/cornerstone/bundle.js"></script>
{% endblock %}

{% block content %}
<div class="row mb-3">
  <div class="col">
    <h2><i class="fas fa-angle-double-right text-primary text-primary"></i>&nbsp;&nbsp;Viewing: {{case}}</h2>
  </div>
</div>


{% comment %} <form method="post" hx-post="/wado/populate-instances" _="
def swap(attr1, attr2)
    add .{attr1}
    remove .{attr2}
end
on htmx:afterRequest 
    if detail.successful then 
      call location.reload()
    else put 'Error!' into me
        swap('btn-danger','btn-primary')
        call Swal.fire({title: 'Error', text:detail.xhr.responseText})">{% csrf_token %}
  <button class='btn btn-primary mb-3'>Populate</button>
</form> {% endcomment %}



<div style="height:calc(100vh - 6rem); display:grid; grid-template-rows: 0fr 0fr 1fr; grid-template-columns: min-content;" 
  x-data="{ viewer: null, n_annotations: 0, previewing: false, switching: false, current_study: null, index: 0, loading: false, job_loading: null, case_id: {{case.id}} }" >
  <div style="grid-area: 1 / 1 / 1 / 3;">
    <div class="">
      <div class="select-wrapper">
        <select id="studies" name="studies" autocomplete="off" class="form-control" value="" :disabled="viewer == null" 
        @change="loading=true; await $nextTick(); current_study = await viewer.switchStudy($event.target.value.split(':::'), case_id);  loading=false;">
          <option value="" selected disabled hidden>Select study...</option>
          {% for i in studies %}
          <option value="{{i.0}}:::{{i.1}}">{{ i.2 }}</option>
          {% endfor %}
        </select>
        <div class="form-notch"><div class="form-notch-leading" style="width: 9px;"></div><div class="form-notch-middle" style="width: 0px;"></div><div class="form-notch-trailing"></div></div>
      </div>
    </div>
  </div>
  
  <div>
    <div id="chart" style="background-color: black; color: white;"></div>
    <template x-if="viewer">
      <div>
        <select x-model="viewer.chart_options['adjust']" @change="viewer.updateChart()"><option value="normal" autocomplete="off" selected>normal</option><option value="zeroed">zeroed</option><option value="normalized">normalized</option></select>
        <select x-model="viewer.chart_options['mode']" @change="viewer.updateChart()"><option value="mean" autocomplete="off" selected>mean</option><option value="median">median</option><option value="ptp">ptp</option></select>
      </div>
    </template>
  </div>
  <div id="annotations" style="overflow-y: hidden; display: flex; flex-direction: column; flex-wrap: wrap;">
    <template x-show="!!viewer" x-for="uid in (viewer? Object.keys(viewer.annotation_manager.annotations) : [])" :key="uid">
      <div x-show="!!viewer.annotation_manager.annotations[uid]">
        <div x-text="viewer.annotation_manager.annotations[uid] ? viewer.annotation_manager.annotations[uid].label : 'Error'"></div>
        <button class="btn-primary btn-large m-2" @click="await viewer.annotation_manager.deleteAnnotation(uid);">Delete</button>
        <button class="btn-primary btn-large m-2" @click="await viewer.annotation_manager.goToAnnotation(uid);">Jump</button>
      </div>
    </template>  
  </div>
  <div x-cloak id="grasp-view-outer" class="grid-container h-100" style="max-width: calc(100vh - 6rem); grid-area: 2 / 2 / -1 / -1;" >
    <div x-show="loading" style="z-index:10;" class="pointer-events-none grid-fill">
      <div style="display: flex;justify-content: center;align-items: center; height:100%">Loading...</div>
    </div>
    <div x-init="await $nextTick(); viewer = await new GraspViewer($refs.viewer_main, $refs.viewer_preview ); window.viewer = viewer" class="grid-fill grid-container h-100">
      <div x-ref="viewer_preview" class="grid-fill h-100" :style="{ 'z-index': (previewing || switching) ? 1 : 0 }"></div>
      <div x-ref="viewer_main"  class="grid-fill h-100" :style="{ 'z-index': (previewing || switching) ? 0 : 1 }"></div>
    </div>

    <div x-show="!!current_study" class="pointer-events-none grid-fill" style="z-index:1;">
      <div style='display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; height:100%'>
        <template x-for="i in 3">
          <div>
            <button style="pointer-events: auto" class="btn-primary btn-large ms-2 my-2" 
            :disabled="switching || job_loading != null"
            @click="viewer.annotation_manager.addAnnotationToViewport('GravisROI',i-1);"><i class="fa-regular fa-circle"></i>
          </button><button style="pointer-events: auto" class="btn-primary btn-large ms-2 my-2" 
              :disabled="switching || job_loading != null"
              @click="viewer.annotation_manager.addAnnotationToViewport('Probe',i-1);"><i class="fa-solid fa-plus"></i>
          </button><button style="pointer-events: auto" class="btn-primary btn-large ms-2 my-2"
              :disabled="switching || job_loading != null"
              @click="viewer.viewports[i-1].setZoom(1);viewer.viewports[i-1].setPan([0,0]);  viewer.viewports[i-1].render();"><i class="fa-solid fa-arrows-to-circle"></i>
          </button><button style="pointer-events: auto" class="btn-primary btn-large ms-2 my-2"
            :disabled="switching || job_loading != null"
            @click="viewer.annotation_manager.duplicateSelectedAnnotation();"><i class="fa-solid fa-copy"></i>
          </button><button style="pointer-events: auto" class="btn-primary btn-large ms-2 my-2"
            :disabled="switching || job_loading != null"
            @click="viewer.annotation_manager.deleteSelectedAnnotations();"><i class="fa-solid fa-trash"></i>
          </button><button style="pointer-events: auto" class="btn-primary btn-large ms-2 my-2"
            :disabled="switching || job_loading != null"
            @click="viewer.annotation_manager.flipSelectedAnnotations();">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-symmetry-vertical" viewBox="0 0 16 16">
              <path d="M7 2.5a.5.5 0 0 0-.939-.24l-6 11A.5.5 0 0 0 .5 14h6a.5.5 0 0 0 .5-.5v-11zm2.376-.484a.5.5 0 0 1 .563.245l6 11A.5.5 0 0 1 15.5 14h-6a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .376-.484zM10 4.46V13h4.658L10 4.46z"/>
            </svg>
          </button>


          <template x-if="viewer && viewer.getNativeViewports().indexOf(viewer.viewports[i-1].id) > -1"><div>Native</div></template>
          </div>
        </template>
        <div>
          <button style="pointer-events: auto" class="btn-primary btn-large ml-2 my-2" 
          @click="viewer.viewports[3].setStack((await (await fetch(`/api/case/${case_id}/dicom_set/${viewer.dicom_set}/processed_results/MIP?acquisition_number=35`)).json()).urls)">MIP
          </button>
          <button style="pointer-events: auto" class="btn-primary btn-large ml-2 my-2" 
          @click="viewer.viewports[3].setStack((await (await fetch(`/api/case/${case_id}/dicom_set/${viewer.dicom_set}/processed_results/SUB?acquisition_number=35`)).json()).urls)">SUB
          </button>
        </div>
          <div>
            <div x-show="job_loading" style="height:100%;">
              <div style="display: flex;justify-content: center;align-items: center; height:100%; background-color:rgba(0, 0, 0, 0.5);">Loading...</div>
            </div>
          </div>
      </div>
    </div> 

    <div> 
      <div style="display: flex;">
        <input id='volume-picker' type='range' value=0 step="1" autocomplete="off" style="flex-grow:1;"
        @mouseUp="previewing = false"
        @input="if (!previewing) { viewer.startPreview(); previewing = true; }; index = $event.target.value; viewer.selected_time=current_study[index].acquisition_seconds; viewer.setPreview(index,current_study.length);"
        @change="switching = true; await viewer.switchSeries(current_study[index].series_uid); current_time=viewer.selected_time; switching = false;"
        :disabled="!current_study || !!loading">
        </input>
        <label for='volume-picker' x-text="viewer && viewer.selected_time.toFixed(2) + 's'" style="min-width: 4em; text-align: right;"></label>
      </div>
    </div>
  </div>
</div>
<script defer type="module">
  import { GraspViewer, doJob } from "/static/js/viewer.js"
  import { doFetch } from "/static/js/utils.js"
  window.GraspViewer = GraspViewer;
  window.doJob = doJob;
  window.doFetch = doFetch;
</script>
{% endblock %}
