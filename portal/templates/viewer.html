{% extends 'portal.html' %}

{% block header %}
<script src="/static/js/dygraph.min.js"></script>
<link rel="stylesheet" href="/static/css/dygraph.min.css" />
{% endblock %}

{% block addedscripts %}
<script defer src="/static/js/cornerstone/bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
<style>
.bootstrap-select .dropdown-toggle:focus, .bootstrap-select>select.mobile-device:focus+.dropdown-toggle {
    outline: thin dotted #333!important;
    outline: none;
    outline-offset: 0;
}
</style>
{% endblock %}


{% comment %} <form method="post" hx-post="/wado/populate-instances" _="
def swap(attr1, attr2)
    add .{attr1}
    remove .{attr2}
end
on htmx:afterRequest 
    if detail.successful then 
      call location.reload()
    else put 'Error!' into me
        swap('btn-danger','btn-primary')
        call Swal.fire({title: 'Error', text:detail.xhr.responseText})">{% csrf_token %}
  <button class='btn btn-primary mb-3'>Populate</button>
</form> {% endcomment %}


{% block content %}
{{ studies|json_script:"studies_data" }}
<script type="text/javascript">
  const studies_data_parsed = JSON.parse(document.getElementById('studies_data').textContent);    
</script>
<div class="grid"
  x-data="{ viewer: null, n_annotations: 0, previewing: false, switching: false, current_study: null, index: 0, loading: false, job_loading: null, case_id: {{case.id}} }" >
   
  <!-- dicom set selector -->
  <div class="toolbar-area">

  <!-- dicom set selection -->
  <div class="" style="margin-right: 1em">
    <select id="studies" name="studies" autocomplete="off" class="selectpicker show-tick" value="" data-style="btn btn-outline-light btn-lg btn-rounded text-light btn-viewer-toolbar" data-width="100px"
    @change="loading=true; await $nextTick(); current_study = await viewer.switchStudy($event.target.value.split(':::'), case_id);  loading=false;">
      <!-- <option value="" selected disabled hidden>Select study...</option> -->
      <optgroup label="Displayed Series">
      {% for i in studies %}
      <option value="{{i.0}}:::{{i.1}}">{{ i.2 }}</option>
      {% endfor %}
      </optgroup>      
  </select>
  </div>    

  <!-- volume picker -->
  <!-- x-model="value" x-ref="input" x-on:focus="() => { $refs.input.focus() }"  -->
  <input id='volume-picker' tabindex='1' 
      type='range' value=0 step="1" autocomplete="off" style="flex-grow:1;"
      @mouseUp="previewing = false"
      @input="if (!previewing) { viewer.startPreview(); previewing = true; }; index = $event.target.value; viewer.selected_time=current_study[index].acquisition_seconds; viewer.setPreview(index,current_study.length);"
      @change="switching = true; viewer.selected_time=current_study[index].acquisition_seconds; await viewer.switchSeries(current_study[index].series_uid); current_time=viewer.selected_time; switching = false;"
      :disabled="!current_study || !!loading"
      @keydown.left=""
      @keydown.right=""
      >
      </input>
      <label for='volume-picker' x-text="viewer && viewer.selected_time.toFixed(2) + 's'" style="min-width: 4em; text-align: right;"></label>
  
  <!-- Annotations -->
    <!-- <div class="" style="margin-left: 1em">
      <select id="annotations_select" name="annotations" autocomplete="off" class="selectpicker" value=""  data-style="btn btn-outline-light btn-lg btn-rounded text-light btn-viewer-toolbar" data-width="100px"
      @change="let annotation_select = $event.target.value; $event.target.value = ''; await viewer.annotation_manager.goToAnnotation(annotation_select);">
        <option value="" selected disabled>Select ROI</option>
        <template x-show="!!viewer" x-for="uid in (viewer? Object.keys(viewer.annotation_manager.annotations) : [])" :key="uid">
          <option x-text="(viewer.annotation_manager.annotations[uid] || {}).label" :value="uid"></option>
        </template>
      </select>
    </div> -->

  <div class="" style="margin-left: 2em">
    <div class="dropdown">
      <button
        class="btn-primary btn-large btn-viewer"
        href="#"
        role="button"
        id="dropdownMenuLink"
        data-mdb-toggle="dropdown"
        aria-expanded="false"
      >
      <i class="fas fa-map-marker-alt"></i>
    </button>
      <ul class="dropdown-menu" aria-labelledby="dropdownMenuLink">
        <template x-show="!!viewer" x-for="uid in (viewer? Object.keys(viewer.annotation_manager.annotations) : [])" :key="uid">
          <li><a class="dropdown-item" href="#" x-text="(viewer.annotation_manager.annotations[uid] || {}).label"></a></li>
        </template>               
      </ul>
    </div>    
  </div>

  <!-- Image manipulation buttons -->
    <button title="Duplicate Selected Annotation" style="pointer-events: auto" class="btn-primary btn-large btn-viewer ms-2 my-2"
        :disabled="switching || job_loading != null"
        @click="viewer.annotation_manager.duplicateSelectedAnnotation();"><i class="fa-solid fa-copy"></i>
    </button>
    <button title="Flip Selected Annotation" style="pointer-events: auto" class="btn-primary btn-large btn-viewer ms-2 my-2"
        :disabled="switching || job_loading != null"
        @click="viewer.annotation_manager.flipSelectedAnnotations();">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-symmetry-vertical" viewBox="0 0 16 16">
        <path d="M7 2.5a.5.5 0 0 0-.939-.24l-6 11A.5.5 0 0 0 .5 14h6a.5.5 0 0 0 .5-.5v-11zm2.376-.484a.5.5 0 0 1 .563.245l6 11A.5.5 0 0 1 15.5 14h-6a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .376-.484zM10 4.46V13h4.658L10 4.46z"/>
      </svg>
    </button>
    <button title="Delete Selected Annotation" style="pointer-events: auto" class="btn-primary btn-large btn-viewer ms-2 my-2"
      :disabled="switching || job_loading != null"
      @click="viewer.annotation_manager.deleteSelectedAnnotations();"><i class="fa-solid fa-trash"></i>
    </button>
    <button 
        title="Delete All Annotations" 
        style="pointer-events: auto; background-color:red;" 
        class="btn-primary btn-large btn-viewer ms-2 my-2"
        :disabled="switching || job_loading != null"
        @click="viewer.annotation_manager.deleteAllAnnotations();">
        <i class="fa-solid fa-trash"></i>
    </button>

    <div class="spinner-border spinner-border-sm ms-3" role="status" style="color: hsla(0,0%,100%,.55);">
      <span class="visually-hidden">Loading...</span>
    </div>
</div>

  <div x-cloak id="grasp-view-outer" class="grid-container h-100" style="width: 100%; grid-area: e" >
    <div x-show="loading" style="z-index:10;" class="pointer-events-none grid-fill">
      <div style="display: flex;justify-content: center;align-items: center; height:100%">Loading...</div>
    </div>
    <div x-init="await $nextTick(); viewer = await new GraspViewer($refs.viewer_main, $refs.viewer_preview ); window.viewer = viewer; 
    current_study = await viewer.switchStudy([studies_data_parsed[0][0], studies_data_parsed[0][1]], case_id);" class="grid-fill grid-container h-100">
      <div x-ref="viewer_preview" class="grid-fill h-100" :style="{ 'z-index': (previewing || switching) ? 1 : 0 }"></div>
      <div x-ref="viewer_main" class="grid-fill h-100" :style="{ 'z-index': (previewing || switching) ? 0 : 1 }"></div>
    </div>

    <!-- AX/COR/SAG viewer -->
    <div x-show="!!current_study" class="pointer-events-none grid-fill" style="z-index:1;">
      <div class="viewer-grid">
        <template x-for="i in 3">
          <div class="viewport-overlay" :id="'viewport-overlay-'+i" :style="`grid-row: 1; grid-column: ${i}`">
            <button title="Add Elliptical ROI Annotation" style="pointer-events: auto" class="btn-primary btn-large btn-viewer ms-2 my-2" 
                :disabled="switching || job_loading != null"
                @click="viewer.annotation_manager.addAnnotationToViewport('EllipticalROI',i-1);"><i class="fa-regular fa-circle"></i>
            </button>
            <button title="Add Probe Annotation" style="pointer-events: auto" class="btn-primary btn-large btn-viewer ms-2 my-2" 
                :disabled="switching || job_loading != null"
                @click="viewer.annotation_manager.addAnnotationToViewport('Probe',i-1);"><i class="fa-solid fa-plus"></i>
            </button>
            <button title="Zoom" style="pointer-events: auto" class="btn-primary btn-large btn-viewer ms-2 my-2"
                :disabled="switching || job_loading != null"
                @click="viewer.viewports[i-1].setZoom(1);viewer.viewports[i-1].setPan([0,0]);  viewer.viewports[i-1].render();"><i class="fa-solid fa-arrows-to-circle"></i>
            </button>
            <button title="Store Finding" style="pointer-events: auto" class="btn-primary btn-large btn-viewer ms-2 my-2"
                :disabled="switching || job_loading != null"
                @click="viewer.storeFinding(i-1);"><i class="fa-solid fa-camera"></i>
            </button>            
            <template x-if="viewer && viewer.getNativeViewports().indexOf(viewer.viewports[i-1].id) > -1">
              <div>
                Native
              </div>
            </template>
          </div>
        </template>
        <div>
          <div x-show="job_loading" style="height:100%;">
            <div style="display: flex;justify-content: center;align-items: center; height:100%; background-color:rgba(0, 0, 0, 0.5);">
              Loading...
            </div>
          </div>
        </div>
      </div>
    </div>     
  </div>

  <!-- MIP viewer -->
  <div style="grid-area: d" class="mb-2" id="aux-container">
    <div x-show="!!current_study" class="viewport-overlay" style="position: absolute; left: 3em;z-index: 10;">
      <button style="pointer-events: auto" class="btn-primary btn-large btn-viewer ml-2 my-2" 
        @click="viewer.renderingEngine.getViewport('VIEW_CINE').setStack((await (await fetch(`/api/case/${case_id}/dicom_set/${viewer.dicom_set}/processed_results/MIP?acquisition_number=35`)).json()).urls)">MIP
      </button>
    </div>
  </div>

  <!-- Chart -->
  <div style="grid-area: f" class="mb-2">
    <div id="chart" style="background-color: black; color: white;">
    </div>
  </div>
  <div style="grid-area: f">
    <template x-if="viewer">    
      <div style="text-align:right; position:relative;">
        <select style="width:100px;" x-model="viewer.chart_options['adjust']" @change="viewer.annotation_manager.updateChart()">
          <option value="normal" autocomplete="off" selected>normal</option>
          <option value="zeroed">zeroed</option>
          <option value="normalized">normalized</option>
        </select>
        <select style="width:100px;" x-model="viewer.chart_options['mode']" @change="viewer.annotation_manager.updateChart()">
          <option value="mean" autocomplete="off" selected>mean</option>
          <option value="median">median</option>
          <option value="ptp">ptp</option>
        </select>
      </div>    
    </template>
  </div>
   
  <!-- Findings -->
  <div id="findings" style="overflow-y: auto; display: flex; flex-direction: column; flex-wrap: nowrap; grid-area: g; margin-left: 8px; overflow-y: scroll; ">
    <template x-for="finding in viewer? viewer.findings : []" :key="finding.id">
      <div class="mb-2 img-thumbnail">
        <button title="Delete" class="btn-dark btn-large btn-viewer ms-2 my-2" style="float:right;"
        @click="viewer.deleteFinding(finding.id);"><i class="fa-solid fa-trash"></i>
      </button>
        <img class="mb-2 img-fluid" :src="finding.url" width="100%"/>
      </div>
    </template>
  </div>    
</div>

{% include "case_information_modal.html" %}

<script defer type="module">
  import { GraspViewer, doJob } from "/static/js/viewer.js"
  import { doFetch } from "/static/js/utils.js"
  window.GraspViewer = GraspViewer;
  window.doJob = doJob;
  window.doFetch = doFetch;
</script>


<script>
  function closeCurrentCase() {
    Swal.fire({
      title: 'Are you sure?',
      text: "Unsaved findings will be lost.",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#1266f1',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Close'
    }).then((result) => {
      if (result.isConfirmed) {
        // TODO
      }
    })    
  }
</script>

{% endblock %}
