{% extends 'portal.html' %}

{% block header %}
<script src="//cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.min.js"></script>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.min.css" />
{% endblock %}

{% block addedscripts %}
<script defer src="/static/js/cornerstone/bundle.js"></script>
{% endblock %}

{% block content %}
<div class="row mb-3">
  <div class="col">
    <h2><i class="fas fa-angle-double-right text-primary text-primary"></i>&nbsp;&nbsp;Viewing: {{case}}</h2>
  </div>
</div>


{% comment %} <form method="post" hx-post="/wado/populate-instances" _="
def swap(attr1, attr2)
    add .{attr1}
    remove .{attr2}
end
on htmx:afterRequest 
    if detail.successful then 
      call location.reload()
    else put 'Error!' into me
        swap('btn-danger','btn-primary')
        call Swal.fire({title: 'Error', text:detail.xhr.responseText})">{% csrf_token %}
  <button class='btn btn-primary mb-3'>Populate</button>
</form> {% endcomment %}
{% comment %} 
<div class="w-25">
<div class="">
  <div class="select-wrapper">
    <select autocomplete="off" class="form-control" name="series" id="series" value="" onchange="pickSeries(event)">
      <option value="" selected disabled hidden>Select series...</option>
      {% for i in series %}
          <option value="{{i.0}}:::{{i.1}}">{{ i.2 }}</option>
      {% endfor %}
    </select>
    <div class="form-notch"><div class="form-notch-leading" style="width: 9px;"></div><div class="form-notch-middle" style="width: 0px;"></div><div class="form-notch-trailing"></div></div>
  </div>
</div>
</div> {% endcomment %}


<div style="height:calc(100vh - 6rem); display:grid; grid-template-rows: 0fr 0fr 1fr; grid-template-columns: min-content;" 
  x-data="{ viewer: null, annotations: {}, n_annotations: 0, study_id: null, previewing: false, switching: false, current_study: null, current_time: 0, index: 0, loading: false, job_loading: null, case_id: {{case.id}}, dicom_set: null }" >
  <div style="grid-area: 1 / 1 / 1 / 3;">
    <div class="">
      <div class="select-wrapper">
        <select autocomplete="off" class="form-control" name="series" id="series" value="" x-bind:disabled="viewer == null"
          @change="loading=true; await $nextTick(); current_study = await viewer.switchStudy($event.target.value.split(':::'), case_id); current_time=current_study[0].acquisition_seconds; study_id = viewer.study_uid; dicom_set=viewer.dicom_set; loading=false;">
          <option value="" selected disabled hidden>Select study...</option>
          {% for i in studies %}
              <option value="{{i.0}}:::{{i.1}}">{{ i.2 }}</option>
          {% endfor %}
        </select>
        <div class="form-notch"><div class="form-notch-leading" style="width: 9px;"></div><div class="form-notch-middle" style="width: 0px;"></div><div class="form-notch-trailing"></div></div>
      </div>
    </div>
  </div>
  <div>
    <div id="chart" style="background-color: black; color: white;"></div>
  </div>
  <div id="annotations">
    <template x-for="uid in Object.keys(annotations)" :key="uid">
      <div x-show="!!annotations[uid]">
        <div x-text="annotations[uid] ? annotations[uid].label : 'Error'"></div>
        <button class="btn-primary btn-large m-2" x-on:click="await viewer.deleteAnnotation(annotations[uid]); delete annotations[uid];">Delete</button>
        <button class="btn-primary btn-large m-2" x-on:click="await viewer.goToAnnotation(annotations[uid]);">Jump</button>
      </div>
    </template>  
  </div>
  <div x-cloak id="grasp-view-outer" class="grid-container h-100" style="max-width: calc(100vh - 6rem); grid-area: 2 / 2 / -1 / -1;" >
    <div x-show="loading" style="z-index:10;" class="pointer-events-none grid-fill">
      <div style="display: flex;justify-content: center;align-items: center; height:100%">Loading...</div>
    </div>
    <div x-init="await $nextTick(); viewer = await new GraspViewer($refs.viewer_main, $refs.viewer_preview ); window.viewer = viewer" class="grid-fill grid-container h-100">
      <div x-ref="viewer_preview" class="grid-fill h-100" :style="{ 'z-index': (previewing || switching) ? 1 : 0 }"></div>
      <div x-ref="viewer_main"  class="grid-fill h-100" :style="{ 'z-index': (previewing || switching) ? 0 : 1 }"></div>
    </div>

    <div x-show="!!current_study" class="pointer-events-none grid-fill" style="z-index:1;">
      <div style='display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; height:100%'>

        <template x-for="i in 3">
          <div>
            <button style="pointer-events: auto" class="btn-primary btn-large m-2" 
              x-text="viewer && viewer.viewportIds[i-1]" 
              x-bind:disabled="job_loading != null"
              x-on:click="let a=(viewer.addAnnotationToViewport(i-1, n_annotations)); annotations[a.uid] = a; n_annotations += 1;">
              </button>
          </div>
        </template>
        <div>
          <button style="pointer-events: auto" class="btn-primary btn-large m-2" 
          x-on:click="viewer.viewports[3].setStack((await (await fetch(`/api/case/${case_id}/dicom_set/${dicom_set}/processed_results/MIP?acquisition_number=3`)).json()).urls)">MIP
          </button>
          <button style="pointer-events: auto" class="btn-primary btn-large m-2" 
          x-on:click="viewer.viewports[3].setStack((await (await fetch(`/api/case/${case_id}/dicom_set/${dicom_set}/processed_results/SUB?acquisition_number=3`)).json()).urls)">SUB
          </button>
        </div>
          <div>
            <div x-show="job_loading" style="height:100%;">
              <div style="display: flex;justify-content: center;align-items: center; height:100%; background-color:rgba(0, 0, 0, 0.5);">Loading...</div>
            </div>
          </div>
      </div>
    </div> 

    <div x-data="{ selected_time:0 }"> 
      <div style="display: flex;">
        <input id='volume-picker' type='range' value=0 step="1" autocomplete="off" style="flex-grow:1;"
        @mouseUp="previewing = false"
        @input="previewing = true; index = $event.target.value; selected_time=current_study[index].acquisition_seconds; viewer.setPreview(index,current_study.length);"
        @change="switching = true; await viewer.switchSeries(current_study[index].series_uid, case_id); current_time=selected_time; switching = false;"
        x-bind:disabled="!current_study || !!loading "
          {% comment %} @input="" {% endcomment %}
          {% comment %} @change="" {% endcomment %}
          ></input>
        <label for='volume-picker' x-text="selected_time.toFixed(2) + 's'" style="min-width: 4em; text-align: right;"></label>
      </div>
    </div>
  </div>
</div>
<script defer src="/static/js/viewer.js"></script>
<script type="text/javascript">
  /*function pickSeries(evt) {
    if (evt.target.value == "") {
      return;
    }
    values = evt.target.value.split(":::")
    studyUID = values[0]
    seriesUID = values[1]
    setVolumeBySeries(studyUID, seriesUID)
  }

  function pickStudy(evt) {
    if (evt.target.value == "") {
      return;
    }
    studyUID = evt.target.value;
    setVolumeByStudy(studyUID)
  }


  window.onload = async function () {
    // 
  }*/
</script>
{% endblock %}
